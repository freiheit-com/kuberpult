name: "Trivy DB Caching"
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  cache:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    env:
      LOCAL_CACHE: ./trivy_db_cache
    steps: 
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install earthly
      uses: earthly/actions-setup@v1
      with:
          version: v0.8.13

    - name: Install oras
      uses: oras-project/setup-oras@v1
      with:
        url: https://github.com/oras-project/oras/releases/download/v1.2.0/oras_1.2.0_linux_amd64.tar.gz
        checksum: 5b3f1cbb86d869eee68120b9b45b9be983f3738442f87ee5f06b00edd0bab336 

    - uses: google-github-actions/auth@v2
      name: "Authenticate to Google Cloud"
      with:
        credentials_json: '${{ secrets.GCP_ARTIFACT_REGISTRY_PUSH_JSON_KEY }}'

    - name: gcloud authorize
      run: |
        gcloud auth configure-docker europe-west3-docker.pkg.dev

    - name: Cache trivy
      run: |
        cd trivy
        earthly +cache-trivy-db --cache_dir $LOCAL_CACHE
        oras push europe-west3-docker.pkg.dev/fdc-public-docker-registry/kuberpult/aquasecurity/trivy-db:2 \
        --config $LOCAL_CACHE/db/metadata.json:application/vnd.oci.empty.v1+json \
                 $LOCAL_CACHE/db/trivy.db:application/vnd.aquasec.trivy.db.layer.v1.tar+gzip
