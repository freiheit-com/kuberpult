name: Testing
'on':
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
jobs:
  # TODO: Remove this job once story [integrate other github actions into execution plan structure](https://revolution.dev/app/-JqFGExX46gs9mH7vxR5/-M37cZx7XYoOvQ5Mmcir/STORY/-N3djfe-fMevnyrNqHzj/) is integrated
  generate_version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Get the version
        id: get_version
        run: |
          echo "::set-output name=VERSION::$(git describe --always --long --tags)"
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}

  docker-build-test:
    needs: generate_version
    name: "Run all UI and unit tests"
    runs-on: ubuntu-latest
    container: europe-west3-docker.pkg.dev/fdc-public-docker-registry/kuberpult/kuberpult-dependencies:0.1.1
    env:
      LD_LIBRARY_PATH: '/usr/local/lib'
      CI: true
    steps:
      - uses: actions/checkout@v2
      - name: Set version
        run: |
          echo "VERSION=${{ needs.generate_version.outputs.version }}" >> $GITHUB_ENV
      - name: Install go dependencies and run tests (charts are not tested here)
        env:
          HOME: /root # set the HOME variable to access the real GOPATH. See: https://github.com/actions/runner/issues/1146
        run: make .install && make test
