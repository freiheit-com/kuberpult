# This file is part of kuberpult.

# Kuberpult is free software: you can redistribute it and/or modify
# it under the terms of the Expat(MIT) License as published by
# the Free Software Foundation.

# Kuberpult is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# MIT License for more details.

# You should have received a copy of the MIT License
# along with kuberpult. If not, see <https://directory.fsf.org/wiki/License:Expat>.

# Copyright 2023 freiheit.com
# This file is part of kuberpult.
{{- if .Values.rollout.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kuberpult-rollout-service
  labels:
    app: kuberpult-rollout-service
{{- if .Values.datadogTracing.enabled }}
    tags.datadoghq.com/service: kuberpult-rollout-service
    tags.datadoghq.com/version: {{ .Values.rollout.tag }}
    tags.datadoghq.com/env: {{ .Values.datadogTracing.environment }}
{{- end }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kuberpult-rollout-service
  template:
    metadata:
      labels:
        app: kuberpult-rollout-service
{{- if .Values.datadogTracing.enabled }}
        tags.datadoghq.com/env: {{ .Values.datadogTracing.environment }}
        tags.datadoghq.com/service: kuberpult-rollout-service
        tags.datadoghq.com/version: {{ .Values.rollout.tag }}
      annotations:
        apm.datadoghq.com/env: '{"DD_SERVICE":"kuberpult-rollout-service","DD_ENV":"{{ .Values.datadogTracing.environment }}","DD_VERSION":"{{ .Values.rollout.tag }}"}'
{{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: service
        image: "{{ .Values.hub }}/{{ .Values.rollout.image }}:{{ .Values.rollout.tag }}"
        ports:
          - name: http
            containerPort: 8080
            protocol: TCP
          - name: grpc
            containerPort: 8443
            protocol: TCP
        readinessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /health
            port: http
        resources:
          limits:
            cpu: "{{ .Values.rollout.resources.limits.cpu }}"
            memory: "{{ .Values.rollout.resources.limits.memory }}"
          requests:
            cpu: "{{ .Values.rollout.resources.requests.cpu }}"
            memory: "{{ .Values.rollout.resources.requests.memory }}"
        env:
        - name: KUBERPULT_CDSERVER
          value: kuberpult-cd-service:8443
        - name: KUBERPULT_ARGOCD_SERVER
          value: {{ .Values.argocd.server | quote }}
        - name: KUBERPULT_ARGOCD_INSECURE
          value: {{ .Values.argocd.insecure | quote }}
        - name: LOG_FORMAT
          value: {{ .Values.log.format | quote }}
        - name: LOG_LEVEL
          value: {{ .Values.log.level | quote }}
{{- if .Values.datadogTracing.enabled }}
        - name: DD_AGENT_HOST
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: DD_ENV
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['tags.datadoghq.com/env']
        - name: DD_SERVICE
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['tags.datadoghq.com/service']
        - name: DD_VERSION
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['tags.datadoghq.com/version']
        - name: KUBERPULT_ENABLE_TRACING
          value: "{{ .Values.datadogTracing.enabled }}"
{{- end }}
{{- if .Values.datadogTracing.enabled }}
        - name: DD_TRACE_DEBUG
          value: "{{ .Values.datadogTracing.debugging }}"
{{- end }}
{{- if .Values.dogstatsdMetrics.enabled }}
        - name: KUBERPULT_ENABLE_METRICS
          value: "{{ .Values.dogstatsdMetrics.enabled }}"
        - name: KUBERPULT_DOGSTATSD_ADDR
          value: "{{ .Values.dogstatsdMetrics.address }}"
{{- end }}

        volumeMounts:
{{- /* We need to mount a writeable tmp directory for argocd connections to work correctly. https://github.com/argoproj/argo-cd/issues/14115 */ -}}
        - name: tmp
          mountPath: /tmp
          readOnly: false
{{- if .Values.dogstatsdMetrics.enabled }}
        - name: dsdsocket
          mountPath: {{ .Values.dogstatsdMetrics.hostSocketPath }}
          readOnly: true
{{- end }}
      volumes:
      - name: tmp
        emptyDir: {}
{{- if .Values.dogstatsdMetrics.enabled }}
      - name: dsdsocket
        hostPath:
          path: {{ .Values.dogstatsdMetrics.hostSocketPath }}
{{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: kuberpult-rollout-service
spec:
  ports:
  - name: http
    port: 80
    targetPort: http
  - name: grpc
    port: 8443
    targetPort: grpc
  selector:
    app: kuberpult-rollout-service
  type: NodePort
---
apiVersion: v1
kind: Secret
metadata:
  name: kuberpult-cd-service
type: Opaque
data:
  KUBERPULT_ARGOCD_TOKEN: {{ .Values.argocd.token | b64enc }}
{{- end }}
